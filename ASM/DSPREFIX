         TITLE 'SUBROUTINE TO RETURN THE DSPREFIX'
* THIS PROGRAM RETURNS THE DSPREFIX CURRENTLY IN USE.
* THE RULES FOR FINDING DATASET ALLOCATIONS ON MVS AND OSIV/F4
*    TCBJSCB POINTS TO JSCB
*    JSCDSABQ POINTS TO QDB
*    QDBFELMP POINTS TO FIRST DSAB
*    QDBLELMP POINTS TO LAST DSAB
*    DSABFCHN POINTS TO THE NEXT DSAB
*    DSABBCHN POINTS TO THE PREVIOUS DSAB
*    DSABTIOT POINTS TO THE TIOT ENTRY
*    TIOT+C POINTS TO JFCB IN SWA (NOTE 3 BYTES FROM +C, NOT 4)
*
*    WHY ALL THIS BOTHER?
*
*     DSAB CONTAINS USEFUL FLAGS SUCH AS IN-USE ATTRIBUTE ETC
*
*
         REGEQU
DSPREFIX CSECT
DSPREFIX SAVE  (5,10),,DSPREFIX
         USING DSPREFIX,R15
R01    EQU  1
         SPACE 1
         L     R9,CVTPTR           LOAD CVT ADDRESS
         L     R9,0(0,R9)          TCB WORDS
         L     R9,4(0,R9)          MY TCB ADDRESS
         USING TCB,R9
         L     R9,TCBJSCB          MY JSCB ADDRESS
         DROP  R9
         USING KDJJSCB,R9
         ICM   R10,15,JSCBPSCB     ARE THERE ANY?
         BZ    NOPREF
         L     R9,JSCBPSCB         PSCB
         DROP  R9
         USING PSCB,R9             PSCB Q DESCRIPTOR BLOCK
         L     R8,PSCBUPT          GET UPT BLOCK
         USING UPT,R8
         LM    R0,R1,UPTPREFX      GET THE DSNAME PREFIX
         SRDL  R0,8
         ICM   R0,8,UPTPREFL       RETURN LENGTH IN TOP BYTE
         RETURN (5,10)
NOPREF   LA    R0,0                RETURN LENGTH IS 0
         LR    R1,R0
         RETURN (5,10)
         DROP  R8
         PRINT OFF
         TITLE 'COMMUNICATIONS VECTOR TABLE'
         CVT   DSECT=YES,SYS=BOTH
         TITLE '  DATA CONTROL BLOCK'
         DCBD  DSORG=PS,DEVD=DA
         PRINT GEN
         TITLE '  USER PROFILE TABLE'
         IKJUPT
         TITLE '  PROTECTED STEP CONTROL BLOCK'
         IKJPSCB
         TITLE '  ENVIRONMENT CONTROL TABLE'
         IKJECT
         TITLE '  PARSE PARAMETER LIST'
         IKJPPL
LENMYPPL EQU   *-PPL
         AGO   .F4CB
         AIF   (&F4).F4CB
         TITLE '  TASK CONTROL BLOCK'
         IKJTCB
         TITLE '  JOB-STEP CONTROL BLOCK'
         IEZJSCB
         TITLE '  DATA-SET ASSOCIATION BLOCK'
         IHADSAB
         TITLE '  DSAB QUEUE DESCRIPTOR BLOCK'
         IHAQDB
         TITLE '  JOB FILE CONTROL BLOCK'
JFCB     DSECT
         IEFJFCBN
         AGO   .CBDUN
.F4CB    ANOP
         TITLE '  TASK CONTROL BLOCK'
         KAATCB
         TITLE '  JOB-STEP CONTROL BLOCK'
         KDJJSCB
         TITLE '  DATA-SET ASSOCIATION BLOCK'
         KDJDSAB
         TITLE '  DSAB QUEUE DESCRIPTOR BLOCK'
         KDJQDB
         TITLE '  JOB FILE CONTROL BLOCK'
JFCB     DSECT
         KDJJFCBN LIST=YES,DSECT=NO
.CBDUN   ANOP
         AIF   ('&GENCB' EQ 'YES').GENCB2
         POP   PRINT
.GENCB2  ANOP
         PRINT ON
         TITLE '  WORK AREA'
         DROP
         END
